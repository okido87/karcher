<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>In Phi·∫øu ƒê·ªÅ Ngh·ªã T√†i Ch√≠nh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Times New Roman', Times, serif; background-color: #e0e0e0; margin: 0; padding: 20px; color: #000; font-size: 11pt; }
        .lang-en { font-style: italic; font-size: 10pt; }
        .data-value { color: #003366; }
        .info-grid .data-value, .form-no .data-value { font-weight: bold; }
        
        .controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            max-width: 210mm;
            margin: 0 auto 20px auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .controls #form-selector {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            font-size: 1em;
            background-color: #f9f9f9;
        }
        .controls .actions {
            display: flex;
            gap: 10px;
        }
        .actions button {
            padding: 10px 15px;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            white-space: nowrap;
        }
        .actions .print-btn { background-color: #28a745; }
        .actions .download-btn { background-color: #dc3545; }

        .page-preview-wrapper { margin: 0 auto; }

        .a4-page {
            width: 210mm;
            height: 296mm; 
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            padding: 10mm 12mm;
            position: relative;
            display: none;
            overflow: hidden;
        }
        .a4-page.active { display: block; }
        
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; font-weight: bold; color: rgba(255, 0, 0, 0.08); pointer-events: none; z-index: 1000; }
        .form-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .form-title { text-align: center; font-size: 16pt; font-weight: bold; margin-top: 10px; margin-bottom: 5px; }
        .form-subtitle { text-align: center; font-size: 12pt; margin-bottom: 25px; }
        
        .info-grid { width: 100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed; }
        .info-grid td { padding: 5px 0; vertical-align: top; }
        .info-grid .label { padding-right: 8px; }
        .info-grid .value { border-bottom: 1px dotted #000; word-break: break-word; }
        .info-grid .value.checkbox-container { border-bottom: none; }
        
        .info-grid .col-1 { width: 25%; }
        .info-grid .col-2 { width: 40%; }
        .info-grid .col-3 { width: 15%; }
        .info-grid .col-4 { width: 20%; }

        .payment-methods { display: flex; flex-wrap: wrap; gap: 20px; }
        .payment-methods .method { display: flex; align-items: center; gap: 8px; }
        .checkbox-box { width: 16px; height: 16px; border: 1px solid black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: sans-serif; }

        .details-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed;}
        .details-table th, .details-table td { border: 1px solid black; padding: 5px; word-break: break-word; }
        .details-table thead { background-color: #e8e8e8; text-align: center; }
        .details-table tbody td { height: 25px; }
        .details-table .number { text-align: right; }
        .details-table .center { text-align: center; }

        .summary-section { margin-bottom: 10px; line-height: 1.5; }
        .amount-in-words { font-weight: bold; font-style: italic; }

        .signature-area { margin-top: 20px; }
        .signature-row { display: flex; justify-content: space-around; align-items: flex-start; margin-bottom: 10px; }
        .signature-row:last-child { margin-bottom: 0; }
        .signature-block { width: 30%; text-align: center; }
        .signature-block .role { font-weight: bold; line-height: 1.3; }
        .signature-block .name-container { margin-top: 40px; font-weight: bold; }
        .signature-date { margin-top: 5px; font-size: 10pt; font-family: 'Times New Roman', Times, serif; font-style: normal; }
        .signature-font { font-family: 'Brush Script MT', 'cursive', sans-serif; font-size: 1.6em; color: #000080; height: 40px; }
        
        @media screen and (min-width: 821px) { .controls { position: fixed; top: 20px; right: 20px; flex-direction: column; align-items: flex-end; width: auto; margin: 0; padding: 10px; z-index: 1001; gap: 10px; } .controls .actions { flex-direction: column; width: 100%; } .controls #form-selector, .controls .actions button { width: 180px; box-sizing: border-box; } }
        @media screen and (max-width: 820px) { body { padding: 10px; background-color: #fff; } .controls { max-width: 100%; } .a4-page { transform: scale(calc(100vw / 215mm)); transform-origin: top left; box-shadow: none; margin: 0; } .page-preview-wrapper { height: calc(296mm * (100vw / 215mm)); } }
        @media print { body { background-color: #fff; padding: 0; margin: 0; } .controls, .no-print { display: none; } .page-preview-wrapper { margin: 0; height: auto; width: auto; } .a4-page { width: 100%; height: 100vh; border: none; box-shadow: none; transform: none; padding: 10mm 12mm; } }
        @page { size: A4; margin: 0; }
    </style>
</head>
<body>

<header class="controls no-print">
    <select id="form-selector">
        <option value="fino1">ƒê·ªÅ ngh·ªã Thanh to√°n (FIN01)</option>
        <option value="fino2">ƒê·ªÅ ngh·ªã T·∫°m ·ª©ng (FIN02)</option>
        <!-- ===== START UPDATE: ADD NEW FORM OPTION ===== -->
        <option value="fino3">ƒê·ªÅ ngh·ªã T·∫°m ·ª©ng l∆∞∆°ng (FIN03)</option>
        <!-- ===== END UPDATE ===== -->
        <option value="fino4">ƒê·ªÅ ngh·ªã Thu Ho√†n ·ª©ng (FIN04)</option>
        <option value="fino5">ƒê·ªÅ ngh·ªã Thu ti·ªÅn (FIN05)</option>
    </select>
    <div class="actions">
        <button class="print-btn">üñ®Ô∏è In Phi·∫øu</button>
        <button class="download-btn">üìÑ T·∫£i v·ªÅ PDF</button>
    </div>
</header>

<div class="page-preview-wrapper"><div id="form-fino1" class="a4-page"></div></div>
<div class="page-preview-wrapper"><div id="form-fino2" class="a4-page"></div></div>
<!-- ===== START UPDATE: ADD NEW FORM CONTAINER ===== -->
<div class="page-preview-wrapper"><div id="form-fino3" class="a4-page"></div></div>
<!-- ===== END UPDATE ===== -->
<div class="page-preview-wrapper"><div id="form-fino4" class="a4-page"></div></div>
<div class="page-preview-wrapper"><div id="form-fino5" class="a4-page"></div></div>

<script>
const demoData = {
    fino1: {
        request: { request_type: "PAYMENT", applicant_name: "TR·∫¶N TH·ªä DUY√äN ANH", department: "K·∫ø to√°n", request_date: "24-Aug-25", ref_no: "REF-00123", vendor_name: "C√¥ng ty TNHH Adeline To√†n C·∫ßu", payment_method: "BANK", settlement_deadline: "30-Sep-25", currency: "VND", exchange_rate: 1, total_amount: 3550000, total_amount_vnd: 3550000, attachments: "H√≥a ƒë∆°n, B√°o gi√°", signatures: { director: "L√™ Vi·ªát H√πng", chief_accountant: "Nguy·ªÖn Th·ªã Lan Anh", head_of_dept: "Tr·∫ßn VƒÉn B√¨nh", accountant: "L√™ Minh Ch√¢u", requestor: "TR·∫¶N TH·ªä DUY√äN ANH" }, bank_name: "ACB - Ng√¢n h√†ng √Å Ch√¢u", bank_account: "123456789", bank_account_holder: "CT TNHH ADELINE TOAN CAU" },
        details: [ 
            { description: "Thanh to√°n ti·ªÅn kh√°ch s·∫°n Adeline (14-16/07)", acc_code: "6428 / 1331", amount: 2700000, amount_vnd: 2700000, remark: "H√≥a ƒë∆°n #123" }, 
            { description: "Chi ph√≠ ƒÉn u·ªëng theo c√¥ng t√°c ph√≠ cho chuy·∫øn c√¥ng t√°c t·∫°i H√† N·ªôi ƒë·ªÉ g·∫∑p g·ª° kh√°ch h√†ng ABC", acc_code: "6422 / 1111", amount: 500000, amount_vnd: 500000, remark: "2 ng√†y" }, 
            { description: "Chi ph√≠ di chuy·ªÉn taxi s√¢n bay", acc_code: "6422 / 1111", amount: 350000, amount_vnd: 350000, remark: null } 
        ]
    },
    // ===== START UPDATE: RESTORE ORIGINAL FIN02 DEMO =====
    fino2: {
        request: { request_type: "ADVANCE", applicant_name: "NGUY·ªÑN VƒÇN AN", department: "Kinh doanh", request_date: "22-Aug-17", ref_no: "REF-00124", balance: 0, settlement_deadline: "31/09/2017", payment_method: "BANK", currency: "USD", exchange_rate: 25000, total_amount: 380, total_amount_vnd: 9500000, signatures: { director: "L√™ Vi·ªát H√πng", chief_accountant: "Nguy·ªÖn Th·ªã Lan Anh", head_of_dept: "Tr·∫ßn VƒÉn B√¨nh", accountant: "L√™ Minh Ch√¢u", requestor: "NGUY·ªÑN VƒÇN AN" }, bank_name: "VCB - Vietcombank", bank_account: "0501000130594", bank_account_holder: "NGUYEN TAN HIEN" },
        details: [ { description: "T·∫°m ·ª©ng mua m√†n h√¨nh Dell U2723QE", amount: 300, amount_vnd: 7500000, remark: "Theo b√°o gi√° Phong V≈©" }, { description: "T·∫°m ·ª©ng mua b√†n ph√≠m c∆°", amount: 80, amount_vnd: 2000000, remark: "Cho nh√¢n vi√™n m·ªõi" } ]
    },
    // ===== END UPDATE =====
    // ===== START UPDATE: ADD NEW FIN03 DEMO =====
    fino3: {
        request: { request_type: "ADVANCE SALARY", applicant_name: "NGUY·ªÑN TH·ªä MAI", department: "Nh√¢n s·ª±", request_date: "25-Aug-25", ref_no: "AS-001", balance: 0, settlement_deadline: "31/08/2025", payment_method: "BANK", currency: "VND", exchange_rate: 1, total_amount: 10000000, total_amount_vnd: 10000000, signatures: { director: "L√™ Vi·ªát H√πng", chief_accountant: "Nguy·ªÖn Th·ªã Lan Anh", head_of_dept: "Tr·∫ßn VƒÉn B√¨nh", accountant: "L√™ Minh Ch√¢u", requestor: "NGUY·ªÑN TH·ªä MAI", hr_manager: "Ph·∫°m Th·ªã C√∫c" }, bank_name: "VCB - Vietcombank", bank_account: "0501000130594", bank_account_holder: "NGUYEN THI MAI" },
        details: [ { description: "T·∫°m ·ª©ng l∆∞∆°ng th√°ng 08/2025", amount: 10000000, amount_vnd: 10000000, remark: "L√Ω do c√° nh√¢n" } ]
    },
    // ===== END UPDATE =====
    fino4: {
        request: { request_type: "REFUND", applicant_name: "TR·∫¶N TH·ªä DUY√äN ANH", department: "K·∫ø to√°n", request_date: "24-Aug-25", ref_no: "REF-00125", payment_method: "CASH", settlement_deadline: "N/A", currency: "VND", exchange_rate: 1, total_amount: 750000, total_amount_vnd: 750000, attachments: "Kh√¥ng c√≥", signatures: { director: "L√™ Vi·ªát H√πng", chief_accountant: "Nguy·ªÖn Th·ªã Lan Anh", head_of_dept: "Tr·∫ßn VƒÉn B√¨nh", requestor: "TR·∫¶N TH·ªä DUY√äN ANH", accountant: "L√™ Minh Ch√¢u" } },
        details: [ { description: "Thu ho√†n ·ª©ng c√¥ng t√°c ph√≠ ng√†y 20/08", amount: 750000, amount_vnd: 750000, remark: "Ho√†n ti·ªÅn th·ª´a sau quy·∫øt to√°n" } ]
    },
    fino5: {
        request: { request_type: "RECEIPT", applicant_name: "PHAN MINH TU·∫§N", department: "K·∫ø to√°n", request_date: "09-Sep-25", ref_no: "", payment_method: "CASH", currency: "EUR", exchange_rate: 27000, total_amount: 100, total_amount_vnd: 2700000, attachments: "", signatures: { director: "L√™ Vi·ªát H√πng", chief_accountant: "Nguy·ªÖn Th·ªã Lan Anh", head_of_dept: "Tr·∫ßn VƒÉn B√¨nh", accountant: "L√™ Minh Ch√¢u", requestor: "PHAN MINH TU·∫§N" } },
        details: [ { description: "Thu ti·ªÅn m·∫∑t b√°n h√†ng", amount: 100, amount_vnd: 2700000, customer_id: "CUS-007", invoice: "INV-2025-098" } ]
    }
};

function formatCurrency(num) { if (num === null || num === undefined || num === '') return ''; return Number(num).toLocaleString('vi-VN'); }
function numberToWords(n) { if (n === null || n === undefined) return ''; n = parseInt(n, 10); if (n === 0) return 'Kh√¥ng ƒë·ªìng'; let str = '', hauto = false; const chuSo = [' kh√¥ng', ' m·ªôt', ' hai', ' ba', ' b·ªën', ' nƒÉm', ' s√°u', ' b·∫£y', ' t√°m', ' ch√≠n']; const hang = ['', ' ngh√¨n', ' tri·ªáu', ' t·ª∑']; let i = 0; while (n > 0) { let tram = n % 1000; let s = ''; if (tram > 0 || hauto) { let chuc = Math.floor(tram / 10) % 10; let donvi = tram % 10; let strDonvi = chuSo[donvi]; let strChuc = ''; if (chuc > 1) { strChuc = chuSo[chuc] + ' m∆∞∆°i'; } else if (chuc === 1) { strChuc = ' m∆∞·ªùi'; } if (donvi === 1 && chuc > 1) { strDonvi = ' m·ªët'; } else if (donvi === 5 && chuc > 0) { strDonvi = ' lƒÉm'; } else if (donvi === 4 && chuc > 1) { strDonvi = ' t∆∞'; } if (chuc === 0 && donvi > 0 && Math.floor(tram / 100) > 0) { s = ' l·∫ª' + strDonvi; } else { s = strChuc + strDonvi; } let strTram = chuSo[Math.floor(tram / 100)] + ' trƒÉm'; if (tram < 100) { strTram = ''; } if (tram > 0) { s = strTram + s; } hauto = true; } if (s) { str = s + hang[i] + str; } n = Math.floor(n / 1000); i++; } str = str.trim(); return str.charAt(0).toUpperCase() + str.slice(1) + ' ƒë·ªìng'; }

function buildAndPopulateForm(formType, data, isDemo = false) {
    const { request, details } = data;
    
    const amountForWords = request.total_amount_vnd || request.total_amount;
    if (!request.amount_in_words) { request.amount_in_words = numberToWords(amountForWords); }
    
    // ===== START UPDATE: ADD FIN03 FLAG =====
    const isFino1 = formType === 'fino1', isFino2 = formType === 'fino2', isFino3 = formType === 'fino3', isFino4 = formType === 'fino4', isFino5 = formType === 'fino5';
    // ===== END UPDATE =====
    let title = '', subtitle = '', infoGridHTML = '', detailsTableHTML = '', signatureAreaHTML = '';
    
    if (isFino1) { title = 'ƒê·ªÄ NGH·ªä THANH TO√ÅN'; subtitle = 'PAYMENT REQUEST'; }
    if (isFino2) { title = 'PHI·∫æU ƒê·ªÄ NGH·ªä T·∫†M ·ª®NG'; subtitle = 'REQUEST FOR ADVANCE'; }
    // ===== START UPDATE: ADD FIN03 TITLE =====
    if (isFino3) { title = 'PHI·∫æU ƒê·ªÄ NGH·ªä T·∫†M ·ª®NG L∆Ø∆†NG'; subtitle = 'REQUEST FOR ADVANCE SALARY'; }
    // ===== END UPDATE =====
    if (isFino4) { title = 'ƒê·ªÄ NGH·ªä THU HO√ÄN ·ª®NG'; subtitle = 'REFUND ADVANCE PAYMENT REQUEST'; }
    if (isFino5) { title = 'ƒê·ªÄ NGH·ªä THU TI·ªÄN'; subtitle = 'PAYMENT COLLECTION REQUEST'; }

    const createBankInfoHTML = (req) => {
        const method = req.payment_method?.toLowerCase();
        if (method !== 'bank') { return ''; }

        const infoParts = [];
        const bankAndAccount = `${req.bank_name || ''} - ${req.bank_account || ''}`.trim();
        if (bankAndAccount !== '-') { infoParts.push(bankAndAccount); }

        const holder = req.bank_account_holder || '';
        if (holder) { infoParts.push(holder); }
        
        if (infoParts.length === 0) { return ''; }

        const fullBankInfo = infoParts.join(' - ');

        return `<tr><td class="label col-1">Th√¥ng tin TK <span class="lang-en">(Bank Info)</span>:</td><td class="value" colspan="3"><span class="data-value">${fullBankInfo}</span></td></tr>`;
    };
    
    const baseInfoHTML = `<tr><td class="label col-1">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã <span class="lang-en">(Applicant)</span>:</td><td class="value col-2 data-value">${request.applicant_name || ''}</td><td class="label col-3">Ng√†y <span class="lang-en">(Date)</span>:</td><td class="value col-4 data-value">${request.request_date || ''}</td></tr><tr><td class="label col-1">B·ªô ph·∫≠n <span class="lang-en">(Dept)</span>:</td><td class="value col-2 data-value">${request.department || ''}</td><td class="label col-3">S·ªë <span class="lang-en">(Ref No.)</span>:</td><td class="value col-4 data-value">${request.ref_no || ''}</td></tr>`;

    if (isFino1) {
        infoGridHTML = baseInfoHTML + `<tr><td class="label col-1">Nh√† cung c·∫•p <span class="lang-en">(Vendor name)</span>:</td><td class="value col-2 data-value">${request.vendor_name || ''}</td><td class="label col-3">H·∫°n thanh to√°n <span class="lang-en">(Deadline)</span>:</td><td class="value col-4 data-value">${request.settlement_deadline || ''}</td></tr><tr><td class="label">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="lang-en">(Method of Payment)</span>:</td><td colspan="3" class="value checkbox-container"><div class="payment-methods"><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'visa' ? 'X' : ''}</span> VISA</div><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'debt' ? 'X' : ''}</span> Debt offset</div></div></td></tr>${createBankInfoHTML(request)}`;
    } 
    // ===== START UPDATE: SHARE INFO GRID LOGIC FOR FIN02 & FIN03 =====
    else if (isFino2 || isFino3) {
        infoGridHTML = baseInfoHTML + `<tr><td class="label col-1">S·ªë d∆∞ t·∫°m ·ª©ng <span class="lang-en">(Advance balance)</span>:</td><td class="value col-2 data-value">${formatCurrency(request.balance)}</td><td class="label col-3">H·∫°n thanh to√°n <span class="lang-en">(Deadline)</span>:</td><td class="value col-4 data-value">${request.settlement_deadline || ''}</td></tr><tr><td class="label">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="lang-en">(Method of Payment)</span>:</td><td colspan="3" class="value checkbox-container"><div class="payment-methods"><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div></div></td></tr>${createBankInfoHTML(request)}`;
    } 
    // ===== END UPDATE =====
    else if (isFino4) { 
        infoGridHTML = baseInfoHTML + `<tr><td class="label col-1">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="lang-en">(Method of Payment)</span>:</td><td class="value col-2 checkbox-container"><div class="payment-methods"><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div></div></td><td class="label col-3">H·∫°n thanh to√°n <span class="lang-en">(Deadline)</span>:</td><td class="value col-4 data-value">${request.settlement_deadline || ''}</td></tr>${createBankInfoHTML(request)}`;
    } else if (isFino5) {
        infoGridHTML = baseInfoHTML + `<tr><td class="label">Ph∆∞∆°ng th·ª©c thanh to√°n <span class="lang-en">(Method of Payment)</span>:</td><td colspan="3" class="value checkbox-container"><div class="payment-methods"><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'cash' ? 'X' : ''}</span> Cash</div><div class="method"><span class="checkbox-box data-value">${request.payment_method?.toLowerCase() === 'bank' ? 'X' : ''}</span> Bank transfer</div></div></td></tr>`;
    }

    const isForeignCurrency = request.currency && request.currency.toUpperCase() !== 'VND';
    let currencyInfoHTML = '', tableHeaders = '', tableFooter = '', detailsRowsHTML = '';

    if (isForeignCurrency) {
        currencyInfoHTML = `<div class="summary-section" style="margin-bottom: 5px; text-align: right;"><strong>Lo·∫°i ti·ªÅn <span class="lang-en">(Currency)</span>:</strong> <span class="data-value">${request.currency}</span> &nbsp;&nbsp;&nbsp;&nbsp;<strong>T·ª∑ gi√° <span class="lang-en">(Exchange Rate)</span>:</strong> <span class="data-value">${formatCurrency(request.exchange_rate)}</span></div>`;
        if (isFino1) {
             tableHeaders = `<th style="width:5%">STT<br><span class="lang-en">No</span></th><th style="width:33%">Di·ªÖn gi·∫£i<br><span class="lang-en">Description</span></th><th style="width:15.5%">S·ªë ti·ªÅn (${request.currency})<br><span class="lang-en">Amount</span></th><th style="width:15.5%">S·ªë ti·ªÅn (VND)<br><span class="lang-en">Amount</span></th><th style="width:21%">M√£ TK<br><span class="lang-en">Acc Code</span></th><th style="width:10%">Ghi ch√∫<br><span class="lang-en">Remark</span></th>`;
            details.forEach((item, index) => { detailsRowsHTML += `<tr><td class="center data-value">${index + 1}</td><td class="data-value">${item.description || ''}</td><td class="number data-value">${formatCurrency(item.amount)}</td><td class="number data-value">${formatCurrency(item.amount_vnd)}</td><td class="center data-value">${item.acc_code || ''}</td><td class="data-value">${item.remark || ''}</td></tr>`; });
            tableFooter = `<tfoot><tr><td colspan="2" style="text-align:right; font-weight:bold;">T·ªîNG C·ªòNG <span class="lang-en">(TOTAL)</span></td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount)}</td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount_vnd)}</td><td colspan="2"></td></tr></tfoot>`;
        } else {
            tableHeaders = `<th style="width:5%">STT<br><span class="lang-en">No</span></th><th style="width:35%">Di·ªÖn gi·∫£i<br><span class="lang-en">Description</span></th><th style="width:20%">S·ªë ti·ªÅn (${request.currency})<br><span class="lang-en">Amount</span></th><th style="width:20%">S·ªë ti·ªÅn (VND)<br><span class="lang-en">Amount</span></th><th style="width:20%">Ghi ch√∫<br><span class="lang-en">Remark</span></th>`;
            details.forEach((item, index) => { detailsRowsHTML += `<tr><td class="center data-value">${index + 1}</td><td class="data-value">${item.description || ''}</td><td class="number data-value">${formatCurrency(item.amount)}</td><td class="number data-value">${formatCurrency(item.amount_vnd)}</td><td class="data-value">${item.remark || ''}</td></tr>`; });
            tableFooter = `<tfoot><tr><td colspan="2" style="text-align:right; font-weight:bold;">T·ªîNG C·ªòNG <span class="lang-en">(TOTAL)</span></td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount)}</td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount_vnd)}</td><td></td></tr></tfoot>`;
        }
    } else { 
        if (isFino1) {
            tableHeaders = `<th style="width:5%">STT<br><span class="lang-en">No</span></th><th style="width:40%">Di·ªÖn gi·∫£i<br><span class="lang-en">Description</span></th><th style="width:24%">S·ªë ti·ªÅn (VND)<br><span class="lang-en">Amount</span></th><th style="width:21%">M√£ TK<br><span class="lang-en">Acc Code</span></th><th style="width:10%">Ghi ch√∫<br><span class="lang-en">Remark</span></th>`;
            details.forEach((item, index) => { detailsRowsHTML += `<tr><td class="center data-value">${index + 1}</td><td class="data-value">${item.description || ''}</td><td class="number data-value">${formatCurrency(item.amount)}</td><td class="center data-value">${item.acc_code || ''}</td><td class="data-value">${item.remark || ''}</td></tr>`; });
            tableFooter = `<tfoot><tr><td colspan="2" style="text-align:right; font-weight:bold;">T·ªîNG C·ªòNG <span class="lang-en">(TOTAL)</span></td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount)}</td><td colspan="2"></td></tr></tfoot>`;
        } else {
            const headerWidths = isFino5 ? {no: '5%', desc: '40%', amount: '25%', remark: '30%'} : {no: '9%', desc: '46%', amount: '25%', remark: '20%'};
            tableHeaders = `<th style="width:${headerWidths.no}">STT<br><span class="lang-en">No</span></th><th style="width:${headerWidths.desc}">Di·ªÖn gi·∫£i<br><span class="lang-en">Description</span></th><th style="width:${headerWidths.amount}">S·ªë ti·ªÅn (VND)<br><span class="lang-en">Amount</span></th><th style="width:${headerWidths.remark}">Ghi ch√∫<br><span class="lang-en">Remark</span></th>`;
            details.forEach((item, index) => { detailsRowsHTML += `<tr><td class="center data-value">${index + 1}</td><td class="data-value">${item.description || ''}</td><td class="number data-value">${formatCurrency(item.amount)}</td><td class="data-value">${item.remark || ''}</td></tr>`; });
            tableFooter = `<tfoot><tr><td colspan="2" style="text-align:right; font-weight:bold;">T·ªîNG C·ªòNG <span class="lang-en">(TOTAL)</span></td><td class="number data-value" style="font-weight:bold;">${formatCurrency(request.total_amount)}</td><td></td></tr></tfoot>`;
        }
    }

    const advanceDetailTitle = (isFino2 || isFino3) ? `<p style="font-weight:bold;">Chi ti·∫øt t·∫°m ·ª©ng <span class="lang-en">(Advance detail)</span>:</p>` : '';
    detailsTableHTML = `${advanceDetailTitle}${currencyInfoHTML}<table class="details-table"><thead><tr>${tableHeaders}</tr></thead><tbody>${detailsRowsHTML}</tbody>${tableFooter}</table>`;

    const buildSignature = (roleName, name) => { 
        const roleHTML = `<div class="role">${roleName}</div>`;
        const dateHTML = `<div class="signature-date">Date: ___/___/________</div>`;
        let nameContainerContent = '';
        if (!name) { nameContainerContent = `<div class="name-text"></div>`; } 
        else if (isDemo) { const lastName = name.split(' ').pop(); nameContainerContent = `<div class="signature-font">${lastName}</div><div class="name-text data-value">${name.toUpperCase()}</div>`; } 
        else { nameContainerContent = `<div class="name-text data-value">${name.toUpperCase()}</div>`; }
        const nameContainerHTML = `<div class="name-container">${nameContainerContent}</div>`;
        return `${roleHTML}${nameContainerHTML}${dateHTML}`;
    };
    
    const signatures = { 
        director: isDemo ? request.signatures.director : request.approver_id, chief_accountant: isDemo ? request.signatures.chief_accountant : request.chief_accountant_id, 
        head_of_dept: isDemo ? request.signatures.head_of_dept : request.checker_id, requestor: isDemo ? request.signatures.requestor : request.applicant_id, 
        accountant: isDemo ? request.signatures.accountant : request.accountant_id, hr_manager: isDemo ? request.signatures.hr_manager : request.hr_manager_id
    };

    const sigDirectorHTML = buildSignature('Gi√°m ƒë·ªëc<br><span class="lang-en">Director</span>', signatures.director); 
    const sigChiefAccHTML = buildSignature('K·∫ø to√°n tr∆∞·ªüng<br><span class="lang-en">Chief accountant</span>', signatures.chief_accountant); 
    const sigHeadDeptHTML = buildSignature('Tr∆∞·ªüng b·ªô ph·∫≠n<br><span class="lang-en">Head of dept.</span>', signatures.head_of_dept); 
    const sigRequestorHTML = buildSignature('Ng∆∞·ªùi ƒë·ªÅ ngh·ªã<br><span class="lang-en">Requestor</span>', signatures.requestor); 
    const sigAccountantHTML = buildSignature('K·∫ø to√°n thanh to√°n<br><span class="lang-en">Accountant</span>', signatures.accountant);
    
    // ===== START UPDATE: SIMPLIFIED SIGNATURE LOGIC =====
    let signatureRow2LastBlock = '<div class="signature-block"></div>';
    if (isFino3) {
        const sigHrManagerHTML = buildSignature('TP. Nh√¢n s·ª±<br><span class="lang-en">HR & Admin Manager</span>', signatures.hr_manager);
        signatureRow2LastBlock = `<div class="signature-block">${sigHrManagerHTML}</div>`;
    }
    signatureAreaHTML = `<div class="signature-area"><div class="signature-row"><div class="signature-block">${sigDirectorHTML}</div><div class="signature-block">${sigChiefAccHTML}</div><div class="signature-block">${sigHeadDeptHTML}</div></div><div class="signature-row"><div class="signature-block">${sigRequestorHTML}</div><div class="signature-block">${sigAccountantHTML}</div>${signatureRow2LastBlock}</div></div>`;
    // ===== END UPDATE =====
    
    const attachmentsHTML = (isFino1 || isFino4 || isFino5) ? `<div class="summary-section"><strong>Ch·ª©ng t·ª´ ƒë√≠nh k√®m <span class="lang-en">(Supporting document)</span>:</strong> <span class="data-value">${request.attachments || ''}</span></div>` : '';
    const finalHTML = `<div class="watermark">${isDemo ? 'B·∫¢N DEMO' : ''}</div><div class="form-header"><div class="company-name">KARCHER VIETNAM</div><div class="form-no">Form no: <span class="data-value">${formType.toUpperCase().replace('O','0')}</span></div></div><h1 class="form-title">${title}</h1><h2 class="form-subtitle lang-en">${subtitle}</h2><table class="info-grid">${infoGridHTML}</table>${detailsTableHTML}<div class="summary-section"><strong>B·∫±ng ch·ªØ <span class="lang-en">(In words)</span>:</strong> <span class="amount-in-words data-value">${request.amount_in_words || ''}</span></div>${attachmentsHTML}${signatureAreaHTML}`;
    document.getElementById(`form-${formType}`).innerHTML = finalHTML;
}

document.addEventListener('DOMContentLoaded', function() {
    const formSelector = document.getElementById('form-selector');
    const urlParams = new URLSearchParams(window.location.search);
    const processDataFromUrl = () => { try { 
        const requestData = { 
            request_type: urlParams.get('request_type'), applicant_name: urlParams.get('applicant_name'), department: urlParams.get('department'), request_date: urlParams.get('request_date'), ref_no: urlParams.get('ref_no'), vendor_name: urlParams.get('vendor_name'), payment_method: urlParams.get('payment_method'), settlement_deadline: urlParams.get('settlement_deadline'),
            currency: urlParams.get('currency'), exchange_rate: parseFloat(urlParams.get('exchange_rate')), total_amount: parseFloat(urlParams.get('total_amount')),
            total_amount_vnd: parseFloat(urlParams.get('total_amount_vnd')), attachments: urlParams.get('attachments'), balance: parseFloat(urlParams.get('balance')),
            bank_name: urlParams.get('bank_name'), bank_account: urlParams.get('bank_account'), bank_account_holder: urlParams.get('bank_account_holder'),
            applicant_id: urlParams.get('applicant_id'), checker_id: urlParams.get('checker_id'), approver_id: urlParams.get('approver_id'), chief_accountant_id: urlParams.get('chief_accountant_id'), accountant_id: urlParams.get('accountant_id'),
            hr_manager_id: urlParams.get('hr_manager_id')
        };
        
        const detailsDataStr = urlParams.get('details_json');
        if (!detailsDataStr) { throw new Error("details_json parameter is missing"); }
        const detailsData = JSON.parse(detailsDataStr); 
        let activeFormId = ''; 
        const formType = requestData.request_type; 

        // ===== START UPDATE: ROUTING LOGIC FOR FIN03 =====
        if (formType === 'PAYMENT') { activeFormId = 'fino1'; } 
        else if (formType === 'ADVANCE') { activeFormId = 'fino2'; } 
        else if (formType === 'ADVANCE SALARY') { activeFormId = 'fino3'; } 
        else if (formType === 'REFUND') { activeFormId = 'fino4'; } 
        else if (formType === 'RECEIPT') { activeFormId = 'fino5'; } 
        else { loadDemoData(); return; } 
        // ===== END UPDATE =====
        
        buildAndPopulateForm(activeFormId, { request: requestData, details: detailsData }, false); 
        document.querySelectorAll('.page-preview-wrapper').forEach(el => el.style.display = 'none'); 
        document.querySelectorAll('.a4-page').forEach(el => el.classList.remove('active')); 
        const activePageWrapper = document.getElementById(`form-${activeFormId}`).parentElement; 
        activePageWrapper.style.display = 'block'; 
        activePageWrapper.querySelector('.a4-page').classList.add('active'); 
        formSelector.value = activeFormId; 
        formSelector.disabled = true; 
    } catch (e) { console.error("Error parsing AppSheet data:", e); alert("L·ªói d·ªØ li·ªáu ƒë·∫ßu v√†o. Hi·ªÉn th·ªã d·ªØ li·ªáu demo."); loadDemoData(); } };
    
    // ===== START UPDATE: ADD FIN03 TO DEMO LOAD =====
    const loadDemoData = () => { 
        buildAndPopulateForm('fino1', demoData.fino1, true); 
        buildAndPopulateForm('fino2', demoData.fino2, true); 
        buildAndPopulateForm('fino3', demoData.fino3, true);
        buildAndPopulateForm('fino4', demoData.fino4, true); 
        buildAndPopulateForm('fino5', demoData.fino5, true); 
        document.querySelectorAll('.page-preview-wrapper').forEach(el => el.style.display = 'block'); 
        document.querySelectorAll('.a4-page').forEach(el => el.classList.remove('active')); 
        document.getElementById('form-fino1').classList.add('active'); 
        formSelector.value = 'fino1'; 
        formSelector.disabled = false; 
    };
    // ===== END UPDATE =====

    if (urlParams.has('request_type')) { processDataFromUrl(); } else { loadDemoData(); }
    formSelector.addEventListener('change', (e) => { document.querySelectorAll('.a4-page').forEach(el => el.classList.remove('active')); document.getElementById(`form-${e.target.value}`).classList.add('active'); });
    document.querySelector('.print-btn').addEventListener('click', () => window.print());

    document.querySelector('.download-btn').addEventListener('click', () => {
        const activePage = document.querySelector('.a4-page.active');
        const downloadBtn = document.querySelector('.download-btn');
        let data = {};
        const activeId = activePage.id.replace('form-', '');
        const originalBtnText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = 'üîÑ ƒêang x·ª≠ l√Ω...'; downloadBtn.disabled = true;
        if (urlParams.has('request_type')) { data.request = { applicant_name: urlParams.get('applicant_name') || 'unknown', request_date: urlParams.get('request_date') || 'nodate' }; } else { data = demoData[activeId]; }
        const filename = `${activeId.toUpperCase().replace('O','0')}_${data.request.applicant_name.replace(/\s/g, '_')}_${data.request.request_date.replace(/[^a-zA-Z0-9]/g, '-')}.pdf`;
        const originalTransform = activePage.style.transform; const originalBoxShadow = activePage.style.boxShadow; const wrapper = activePage.parentElement; const originalWrapperHeight = wrapper.style.height;
        activePage.style.transform = 'none'; activePage.style.boxShadow = 'none'; wrapper.style.height = 'auto';
        const opt = { margin: 0, filename, image: { type: 'jpeg', quality: 1.0 }, html2canvas: { scale: 2, useCORS: true, letterRendering: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().from(activePage).set(opt).save()
        .catch(err => { console.error("L·ªói khi t·∫°o PDF:", err); alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o file PDF. Vui l√≤ng th·ª≠ l·∫°i."); })
        .finally(() => { activePage.style.transform = originalTransform; activePage.style.boxShadow = originalBoxShadow; wrapper.style.height = originalWrapperHeight; downloadBtn.innerHTML = originalBtnText; downloadBtn.disabled = false; });
    });
});
</script>

</body>
</html>
